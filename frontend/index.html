<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¯ ë” ì •í™•í•œ ìë§‰ ì¶”ì¶œê¸°</title>
  <style>
  body {
    font-family: 'Noto Sans KR', sans-serif;
    max-width: 720px;
    margin: auto;
    padding: 30px;
    background: #EAEFEF; /* ì•„ì£¼ ë°ì€ íšŒìƒ‰ */
    color: #333446; /* ë”¥ ê·¸ë ˆì´ë¸”ë£¨ */
  }
  h1 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 28px;
    color: #333446; /* í—¤ë” ì»¬ëŸ¬ */
  }
  .tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .tabs button {
    padding: 10px 16px;
    border: none;
    background: #B8CFCE; /* ì•½ê°„ ì±„ë„ ë‚®ì¶˜ ë¸”ë£¨ê·¸ë¦° */
    color: #333446;
    cursor: pointer;
    border-radius: 6px;
    font-weight: bold;
    transition: background 0.3s;
  }
  .tabs button:hover {
    background: #7F8CAA; /* ì§„í•œ ë¸”ë£¨ê·¸ë ˆì´ */
  }
  .tab { display: none; }
  .tab.active { display: block; }
  .controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  input[type="text"] {
    width: 100%;
    padding: 12px 3px;
    border-radius: 6px;
    border: 1px solid #7F8CAA;
    font-size: 13px;
    background-color: #EAEFEF;
    color: #333446;
  }
  .row {
    display: flex;
    gap: 10px;
  }
  select, button {
    padding: 12px 3px;
    font-size: 13px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
    flex: 1;
  }
  select {
    border: 1px solid #7F8CAA;
    background-color: #EAEFEF;
    color: #333446;
  }
  #yt-button {
    background-color: #333446;
    color: #EAEFEF;
  }
  #yt-button:hover {
    background-color: #7F8CAA;
    color: #fff;
  }
  #file-button {
    background-color: #333446;
    color: #EAEFEF;
  }
  #file-button:hover {
    background-color: #7F8CAA;
    color: #fff;
  }
  #cancel-button {
    background-color: #B8CFCE;
    color: #333446;
  }
  #cancel-button:hover {
    background-color: #7F8CAA;
    color: #fff;
  }
  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  #loader {
    margin-top: 15px;
    text-align: center;
  }
  .spinner {
    width: 24px;
    height: 24px;
    border: 4px solid #ccc;
    border-top-color: #333446;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 10px auto;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  textarea {
    width: 100%;
    height: 300px;
    margin-top: 20px;
    padding: 12px 3px;
    font-family: monospace;
    border-radius: 6px;
    border: 1px solid #7F8CAA;
    background: #EAEFEF;
    color: #333446;
    resize: vertical;
    white-space: pre-wrap;
    font-size: 14px;
  }
  .output-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }
  .output-controls button, .output-controls select {
    flex: 1;
    padding: 12px;
    font-size: 13px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    background-color: #333446;
    color: #EAEFEF;
    transition: background 0.3s;
  }
  .output-controls button:hover {
    background-color: #7F8CAA;
  }
  #format {
    background-color: #B8CFCE;
    color: #333446;
  }
  .status-message {
    margin-top: 10px;
    font-size: 16px;
    color: #333446;
    text-align: center;
  }
  .tooltip {
    position: relative;
    display: inline-block;
    cursor: pointer;
    margin-left: 5px;
  }
  .tooltip .tooltiptext {
    visibility: hidden;
    width: 220px;
    background-color: #555;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    top: 150%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s;
  }
  .tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }
</style>
</head>
<body>
  <h1>ğŸ¯ ë” ì •í™•í•œ ìë§‰ ì¶”ì¶œê¸°</h1>

  <div class="tabs">
    <button onclick="showTab('youtube')">ğŸ¬ YouTube ìë§‰ ì¶”ì¶œ</button>
    <button onclick="showTab('file')">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</button>
  </div>

  <div id="youtube" class="tab active">
    <div class="controls">
      <input type="text" id="yt-url" placeholder="https://www.youtube.com/watch?v=... ë˜ëŠ” shorts/..." />
      <div class="row">
        <select id="lang">
          <option value="ko" selected>ğŸ‡°ğŸ‡· í•œê¸€ ìë§‰</option>
          <option value="en">ğŸ‡ºğŸ‡¸ ì˜ì–´ ìë§‰</option>
        </select>
        <select id="quality">
          <option value="low" selected>ğŸŸ¢ ì €í’ˆì§ˆ (ë¹ ë¦„)</option>
          <option value="medium">âš–ï¸ ì¤‘ê°„ í’ˆì§ˆ</option>
          <option value="high">ğŸ”µ ê³ í’ˆì§ˆ (ëŠë¦¼)</option>
        </select>
        <button id="yt-button" onclick="extractYouTube()">ğŸ” ìë§‰ ì¶”ì¶œ</button>
        <button id="cancel-button" onclick="cancelRequest()">âŒ ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <div id="file" class="tab">
    <input type="file" id="audio-file" accept="audio/*"/>
    <button id="file-button" onclick="extractFile()">ğŸ”Š ìë§‰ ì¶”ì¶œ</button>
  </div>

  <div id="status" class="status-message"></div>

  <div id="loader" style="display:none;">
    <div class="spinner"></div>
  </div>

  <textarea id="output" readonly placeholder="ì—¬ê¸°ì— ìë§‰ì´ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>

  <div class="output-controls">
    <button onclick="copyText()">ğŸ“‹ ë³µì‚¬</button>
    <button onclick="downloadText()">ğŸ’¾ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ<span class="tooltip">â“˜<span class="tooltiptext">í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ìƒëµëœ ë¶€ë¶„ì€ ì œì™¸ë©ë‹ˆë‹¤.</span></span></button>
     <!-- <select id="format">
      <option value="txt">.txt</option>
      <option value="vtt">.vtt</option>
      <option value="srt">.srt</option>
    </select>
  <button onclick="downloadFromServer()">ğŸŒ ì„œë²„ ë‹¤ìš´ë¡œë“œ<span class="tooltip">â“˜<span class="tooltiptext">ì„œë²„ì—ì„œ ì „ì²´ ìë§‰ íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤. ìƒëµ ì—†ì´ ëª¨ë‘ ì €ì¥ë©ë‹ˆë‹¤.</span></span></button>
  --></div>

  <script>
    let fullText = "";
    let controller = null;

    function showTab(name) {
      clearAll()
      document.querySelectorAll('.tab').forEach(div => div.classList.remove('active'));
      document.getElementById(name).classList.add('active');
    }

    function setLoading(isLoading) {
      const loader = document.getElementById("loader");
      loader.style.display = isLoading ? "block" : "none";
      // document.getElementById("cancel-button").disabled = !isLoading;
      document.getElementById("yt-button").disabled = isLoading;
      document.getElementById("file-button").disabled = isLoading;
      if (isLoading) {
        document.getElementById("status").innerText = "â³ ìë§‰ ì¶”ì¶œ ì¤‘...";
      }
    }

    function cancelRequest() {
      if (controller) {
        controller.abort(); // ìš”ì²­ ì¤‘ì´ë©´ ìš”ì²­ ì¤‘ë‹¨
        controller = null;
        document.getElementById("status").innerText = "ğŸš« ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
        clearText();
      } else {
        document.getElementById("status").innerText = "ğŸ”„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.";
        clearAll();
        location.reload();
      }
    }

    function resetPage(message) {
      document.getElementById("status").innerText = message;
      document.getElementById("yt-url").value = "";
      document.getElementById("lang").value = "ko";
      document.getElementById("quality").value = "low";
      document.getElementById("output").value = "";
      fullText = "";
    }

    async function extractYouTube() {
      const url = document.getElementById("yt-url").value;
      const quality = document.getElementById("quality").value;
      const lang = document.getElementById("lang").value;
      if (!url.includes("watch?v=") && !url.includes("shorts/")) {
        alert("âš ï¸ ìœ íš¨í•œ ìœ íŠœë¸Œ ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      document.getElementById("output").value = "";
      controller = new AbortController();
      const signal = controller.signal;
      setLoading(true);
      const startTime = Date.now();

      try {
        const res = await fetch(`http://127.0.0.1:8000/transcribe_youtube`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, quality, lang }),
          signal
        });
        const data = await res.json();
        fullText = data.transcription || data.error || "âŒ ì˜¤ë¥˜ ë°œìƒ";
        document.getElementById("output").value = fullText.length > 10000 ? fullText.slice(0, 10000) + "\n... ì´í›„ ìƒëµë¨" : fullText;
        const endTime = Date.now();
        document.getElementById("status").innerText = `âœ… ì²˜ë¦¬ ì™„ë£Œ (${((endTime - startTime) / 1000).toFixed(1)}ì´ˆ)`;
        controller = null;
      } catch (e) {
        if (e.name === 'AbortError') {
          console.log("ìš”ì²­ì´ ì·¨ì†Œë¨.");
        } else {
          resetPage("âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        }
      } finally {
        setLoading(false);
      }
    }
    function clearAll() {
      // ì…ë ¥ì°½ ì´ˆê¸°í™”
      document.getElementById("yt-url").value = "";
      document.getElementById("audio-file").value = "";

      // ì¶œë ¥ì°½ ì´ˆê¸°í™”
      document.getElementById("output").value = "";

      // ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
      document.getElementById("status").innerText = "";

      // ë‚´ë¶€ ì €ì¥ëœ ì „ì²´ í…ìŠ¤íŠ¸ë„ ì´ˆê¸°í™”
      fullText = "";

      // ì»¨íŠ¸ë¡¤ëŸ¬ ì´ˆê¸°í™”
      controller = null;
    }

    function clearText() {
      fullText = "";
      document.getElementById("output").value = "";
    }
    async function extractFile() {
      const file = document.getElementById("audio-file").files[0];
      if (!file) {
        alert("âš ï¸ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”");
        return;
      }

      controller = new AbortController();
      const signal = controller.signal;
      setLoading(true);

      try {
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch("http://127.0.0.1:8000/transcribe_file", {
          method: "POST",
          body: formData,
          signal
        });
        const data = await res.json();
        fullText = data.transcription || data.error || "âŒ ì˜¤ë¥˜ ë°œìƒ";
        document.getElementById("output").value = fullText.length > 10000 ? fullText.slice(0, 10000) + "\n... ì´í›„ ìƒëµë¨" : fullText;
        document.getElementById("status").innerText = `âœ… ì²˜ë¦¬ ì™„ë£Œ`;
      } catch (e) {
        if (e.name === 'AbortError') {
          console.log("ìš”ì²­ì´ ì·¨ì†Œë¨.");
        } else {
          resetPage("âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
        }
      } finally {
        setLoading(false);
      }
    }

    function copyText() {
      if (!fullText.trim()) {
        alert("âš ï¸ ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      navigator.clipboard.writeText(fullText);
      alert("âœ… ì „ì²´ ìë§‰ ë³µì‚¬ ì™„ë£Œ!");
    }

    function downloadText() {
      if (!fullText.trim()) {
        alert("âš ï¸ ë‹¤ìš´ë¡œë“œí•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const blob = new Blob([fullText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "subtitle.txt";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function downloadFromServer() {
      const url = document.getElementById("yt-url").value;
      const format = document.getElementById("format").value;
      if (!url.includes("watch?v=") && !url.includes("shorts/")) {
        alert("âš ï¸ ìœ íš¨í•œ ìœ íŠœë¸Œ ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      }
      fetch(`http://127.0.0.1:8000/download?url=${encodeURIComponent(url)}&format=${format}`)
        .then(res => res.blob())
        .then(blob => {
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = blobUrl;
          a.download = `subtitle.${format}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
        });
    }
  </script>
</body>
</html>